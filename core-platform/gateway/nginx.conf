events {}

http {
    # 1. DOCKER DNS RESOLVER (CRITICAL)
    # This allows Nginx to start even if upstream containers are down.
    # It checks DNS every 10 seconds.
    resolver 127.0.0.11 valid=10s;

    # ==========================================
    # CORE API (Auth, Billing)
    # ==========================================
    server {
        listen 80;
        server_name api.lvh.me;

        location / {
            # We assume Core API is always up, but you can use the variable trick here too if you want.
            proxy_pass http://core-api:4000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Cookie $http_cookie;
        }
    }

    # ==========================================
    # DASHBOARD UI
    # ==========================================
    server {
        listen 80;
        server_name app.lvh.me;

        location / {
            proxy_pass http://dashboard-ui:3000;
            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # ==========================================
    # MICRO APP: Node Service (React + Express)
    # Domain: javascript.lvh.me
    # ==========================================
    server {
        listen 80;
        server_name javascript.lvh.me;

        # 1. Backend Route (Dynamic)
        location /api/ {
            # Manual Rewrite: Strip '/api/' from the URL before sending to backend
            rewrite ^/api/(.*) /$1 break;

            # Dynamic Upstream: Nginx won't crash if this container is missing
            set $template_backend "template-backend";
            proxy_pass http://$template_backend:5000;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Cookie $http_cookie;
        }

        # 2. Frontend Route (Dynamic)
        location / {
            set $template_frontend "template-frontend";
            proxy_pass http://$template_frontend:5173;

            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # ==========================================
    # MICRO APP: Python Service (FastAPI + React)
    # Domain: python.lvh.me
    # ==========================================
    server {
        listen 80;
        server_name python.lvh.me;

        # 1. Route API requests to FastAPI
        location /api/ {
            set $python_backend "python-backend";
            proxy_pass http://$python_backend:5000;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Cookie $http_cookie;
        }

        # 2. Route all other requests to React Frontend
        location / {
            set $python_frontend "python-frontend";
            proxy_pass http://$python_frontend:5173;
            
            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}